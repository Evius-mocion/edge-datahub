<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ejemplo de Integraci√≥n - Edge DataHub SDK</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .section h3 {
        color: #333;
        margin-top: 0;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .logs {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .current-player {
        background-color: #e7f3ff;
        border: 1px solid #b3d9ff;
        padding: 15px;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéÆ Ejemplo de Integraci√≥n - Edge DataHub SDK</h1>
      <p>
        Esta es una demostraci√≥n de c√≥mo usar el SDK para integrar con el
        sistema de gamificaci√≥n.
      </p>

      <!-- Estado de conexi√≥n -->
      <div class="section">
        <h3>üì° Estado del Sistema</h3>
        <div id="connectionStatus" class="status info">
          Verificando conexi√≥n...
        </div>
        <div id="queueInfo" class="status info">Cola: 0 elementos</div>
      </div>

      <!-- Informaci√≥n del jugador actual -->
      <div class="section current-player">
        <h3>üë§ Jugador Actual</h3>
        <div id="currentPlayer">
          <em>Ning√∫n jugador registrado</em>
        </div>
      </div>

      <!-- Registro de nuevo asistente -->
      <div class="section">
        <h3>üÜï Registrar Nuevo Asistente</h3>
        <p><strong>‚ö†Ô∏è Requiere conexi√≥n al sistema local</strong></p>
        <div class="form-group">
          <label>Evento ID:</label>
          <input
            type="text"
            id="eventId"
            value="event-uuid-123"
            placeholder="ID del evento"
          />
        </div>
        <div class="form-group">
          <label>Nombre Completo:</label>
          <input type="text" id="fullName" placeholder="Juan P√©rez" />
        </div>
        <div class="form-group">
          <label>Email:</label>
          <input type="email" id="email" placeholder="juan@example.com" />
        </div>
        <div class="form-group">
          <label>Pa√≠s:</label>
          <input
            type="text"
            id="country"
            value="Colombia"
            placeholder="Colombia"
          />
        </div>
        <div class="form-group">
          <label>Ciudad:</label>
          <input type="text" id="city" value="Bogot√°" placeholder="Bogot√°" />
        </div>
        <button onclick="registerAttendee()">Registrar Asistente</button>
        <div id="registerStatus"></div>
      </div>

      <!-- Buscar asistente existente -->
      <div class="section">
        <h3>üîç Buscar Asistente por C√≥digo</h3>
        <div class="form-group">
          <label>C√≥digo del Asistente:</label>
          <input type="text" id="attendeeCode" placeholder="ABC123" />
        </div>
        <button onclick="findAttendee()">Buscar Asistente</button>
        <div id="findStatus"></div>
      </div>

      <!-- Registrar jugada -->
      <div class="section">
        <h3>üéØ Registrar Jugada en Experiencia</h3>
        <p><strong>‚úÖ Se encola autom√°ticamente si no hay internet</strong></p>
        <div class="form-group">
          <label>Experiencia ID:</label>
          <input
            type="text"
            id="experienceId"
            value="experience-uuid-456"
            placeholder="ID de la experiencia"
          />
        </div>
        <div class="form-group">
          <label>Puntuaci√≥n:</label>
          <input type="number" id="score" placeholder="1500" />
        </div>
        <div class="form-group">
          <label>Puntuaci√≥n Bonus:</label>
          <input type="number" id="bonusScore" placeholder="300" />
        </div>
        <div class="form-group">
          <label>Modo de Puntos:</label>
          <select id="modePoints">
            <option value="firstTry">Primer Intento</option>
            <option value="betterTry">Mejor Intento</option>
          </select>
        </div>
        <div class="form-group">
          <label>Datos Adicionales (JSON):</label>
          <textarea
            id="gameData"
            rows="3"
            placeholder='{"level": 3, "timeSpent": 120}'
          ></textarea>
        </div>
        <button onclick="logExperiencePlay()">Registrar Jugada</button>
        <div id="experienceStatus"></div>
      </div>

      <!-- Redimir puntos -->
      <div class="section">
        <h3>üèÜ Redimir Puntos</h3>
        <p><strong>‚úÖ Se encola autom√°ticamente si no hay internet</strong></p>
        <div class="form-group">
          <label>Puntos a Redimir:</label>
          <input type="number" id="pointsToRedeem" placeholder="500" />
        </div>
        <div class="form-group">
          <label>Motivo:</label>
          <input
            type="text"
            id="redemptionReason"
            placeholder="Canje de camiseta oficial"
          />
        </div>
        <button onclick="redeemPoints()">Redimir Puntos</button>
        <div id="redemptionStatus"></div>
      </div>

      <!-- Utilidades -->
      <div class="section">
        <h3>üîß Utilidades</h3>
        <button onclick="forceSync()">üîÑ Forzar Sincronizaci√≥n</button>
        <button onclick="clearQueue()">üóëÔ∏è Limpiar Cola</button>
        <button onclick="showQueueStats()">üìä Ver Estad√≠sticas</button>
      </div>

      <!-- Logs -->
      <div class="section">
        <h3>üìù Logs del Sistema</h3>
        <div id="logs" class="logs"></div>
        <button onclick="clearLogs()">Limpiar Logs</button>
      </div>
    </div>

    <!-- Incluir el SDK -->
    <script src="edge-datahub-sdk.js"></script>

    <script>
      // Configurar SDK
      const sdk = new EdgeDataHubSDK({
        baseUrl: 'http://localhost:3000/edge', // Cambiar por la IP de tu servidor
      });

      let currentAttendee = null;

      // Actualizar estado cada 5 segundos
      setInterval(updateStatus, 5000);
      updateStatus();

      function log(message, type = 'info') {
        const logsDiv = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        const emoji =
          type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üìù';
        logsDiv.innerHTML += `[${timestamp}] ${emoji} ${message}\n`;
        logsDiv.scrollTop = logsDiv.scrollHeight;
      }

      function updateStatus() {
        // Estado de conexi√≥n
        const connectionDiv = document.getElementById('connectionStatus');
        const isOnline = sdk.getConnectionStatus();
        connectionDiv.className = `status ${isOnline ? 'success' : 'error'}`;
        connectionDiv.textContent = isOnline
          ? '‚úÖ Conectado al servidor'
          : '‚ùå Sin conexi√≥n - Modo offline';

        // Estado de la cola
        const queueDiv = document.getElementById('queueInfo');
        const queueSize = sdk.getQueueSize();
        queueDiv.textContent = `Cola: ${queueSize} elementos`;

        // Informaci√≥n del jugador actual
        const playerDiv = document.getElementById('currentPlayer');
        if (currentAttendee) {
          playerDiv.innerHTML = `
                    <strong>Nombre:</strong> ${currentAttendee.fullName}<br>
                    <strong>C√≥digo:</strong> ${currentAttendee.code}<br>
                    <strong>Email:</strong> ${currentAttendee.email}
                `;
        } else {
          playerDiv.innerHTML = '<em>Ning√∫n jugador registrado</em>';
        }
      }

      async function registerAttendee() {
        const eventId = document.getElementById('eventId').value;
        const fullName = document.getElementById('fullName').value;
        const email = document.getElementById('email').value;
        const country = document.getElementById('country').value;
        const city = document.getElementById('city').value;

        if (!eventId || !fullName || !email) {
          showStatus(
            'registerStatus',
            'Por favor completa todos los campos requeridos',
            'error',
          );
          return;
        }

        try {
          log('Intentando registrar asistente...');
          const response = await sdk.registerAttendee({
            eventId,
            fullName,
            email,
            country,
            city,
            properties: {
              registrationSource: 'web-demo',
            },
          });

          currentAttendee = response.attendee;
          showStatus(
            'registerStatus',
            `‚úÖ Asistente registrado exitosamente. C√≥digo: ${currentAttendee.code}`,
            'success',
          );
          log(`Asistente registrado: ${currentAttendee.code}`, 'success');
          updateStatus();
        } catch (error) {
          showStatus('registerStatus', `‚ùå Error: ${error.message}`, 'error');
          log(`Error registrando asistente: ${error.message}`, 'error');
        }
      }

      async function findAttendee() {
        const code = document.getElementById('attendeeCode').value;

        if (!code) {
          showStatus('findStatus', 'Por favor ingresa un c√≥digo', 'error');
          return;
        }

        try {
          log(`Buscando asistente con c√≥digo: ${code}`);
          const response = await sdk.findAttendeeByCode(code);

          currentAttendee = response.attendee;
          showStatus(
            'findStatus',
            `‚úÖ Asistente encontrado: ${currentAttendee.fullName}`,
            'success',
          );
          log(`Asistente encontrado: ${currentAttendee.fullName}`, 'success');
          updateStatus();
        } catch (error) {
          showStatus(
            'findStatus',
            `‚ùå Asistente no encontrado: ${error.message}`,
            'error',
          );
          log(`Error buscando asistente: ${error.message}`, 'error');
        }
      }

      function logExperiencePlay() {
        if (!currentAttendee) {
          showStatus(
            'experienceStatus',
            '‚ùå Primero debes registrar o buscar un asistente',
            'error',
          );
          return;
        }

        const experienceId = document.getElementById('experienceId').value;
        const score = parseInt(document.getElementById('score').value);
        const bonusScore =
          parseInt(document.getElementById('bonusScore').value) || 0;
        const modePoints = document.getElementById('modePoints').value;
        const gameDataText = document.getElementById('gameData').value;

        let gameData = {};
        if (gameDataText) {
          try {
            gameData = JSON.parse(gameDataText);
          } catch (e) {
            showStatus(
              'experienceStatus',
              '‚ùå Error en el formato JSON de datos adicionales',
              'error',
            );
            return;
          }
        }

        if (!experienceId || !score) {
          showStatus(
            'experienceStatus',
            'Por favor completa los campos requeridos',
            'error',
          );
          return;
        }

        sdk.logExperiencePlay({
          eventExperienceId: experienceId,
          attendeeId: currentAttendee.id,
          play_timestamp: new Date().toISOString(),
          data: gameData,
          score,
          bonusScore,
          modePoints,
        });

        showStatus(
          'experienceStatus',
          'üìù Jugada registrada - se sincronizar√° autom√°ticamente',
          'info',
        );
        log(
          `Jugada registrada para ${currentAttendee.fullName}: ${score} puntos`,
          'success',
        );
      }

      function redeemPoints() {
        if (!currentAttendee) {
          showStatus(
            'redemptionStatus',
            '‚ùå Primero debes registrar o buscar un asistente',
            'error',
          );
          return;
        }

        const points = parseInt(
          document.getElementById('pointsToRedeem').value,
        );
        const reason = document.getElementById('redemptionReason').value;

        if (!points || !reason) {
          showStatus(
            'redemptionStatus',
            'Por favor completa todos los campos',
            'error',
          );
          return;
        }

        sdk.redeemPoints({
          eventId: document.getElementById('eventId').value,
          attendeeId: currentAttendee.id,
          pointsRedeemed: points,
          reason,
        });

        showStatus(
          'redemptionStatus',
          'üìù Redenci√≥n procesada - se sincronizar√° autom√°ticamente',
          'info',
        );
        log(
          `Redenci√≥n de ${points} puntos para ${currentAttendee.fullName}: ${reason}`,
          'success',
        );
      }

      async function forceSync() {
        log('Forzando sincronizaci√≥n...');
        await sdk.forceSync();
        log('Sincronizaci√≥n completada', 'success');
        updateStatus();
      }

      function clearQueue() {
        if (confirm('¬øEst√°s seguro de que quieres limpiar toda la cola?')) {
          sdk.clearQueue();
          log('Cola limpiada', 'info');
          updateStatus();
        }
      }

      function showQueueStats() {
        const stats = sdk.getQueueStats();
        log(
          `Estad√≠sticas de cola: Total=${stats.total}, Pendientes=${stats.pending}, Reintentando=${stats.retrying}, Fallidos=${stats.failed}`,
          'info',
        );
      }

      function clearLogs() {
        document.getElementById('logs').innerHTML = '';
      }

      function showStatus(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.className = `status ${type}`;
        element.textContent = message;
      }

      // Log inicial
      log('SDK inicializado correctamente', 'success');
      log(
        'Cambia la baseUrl en el c√≥digo si tu servidor est√° en otra IP',
        'info',
      );
    </script>
  </body>
</html>
